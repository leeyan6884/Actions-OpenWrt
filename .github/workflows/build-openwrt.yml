name: Build OpenWrt

on:
  workflow_dispatch:
  push:
    paths:
      - '.config'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib           g++-multilib gettext git libncurses-dev libssl-dev rsync unzip zlib1g-dev file wget           python3 python3-pip python3-setuptools python3-venv libelf-dev ecj java-propose-classpath           libtool-bin zip upx

    - name: Clone official OpenWrt source
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt openwrt
        cp .config openwrt/.config

    - name: Add custom feeds
      run: |
        cd openwrt
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default
        echo "src-git passwall_pkg https://github.com/xiaorouji/openwrt-passwall-packages" >> feeds.conf.default
        echo "src-git openclash https://github.com/vernesong/OpenClash" >> feeds.conf.default
        echo "src-git mosdns https://github.com/sbwml/luci-app-mosdns" >> feeds.conf.default
        echo "src-git ddnsto https://github.com/linkease/ddnsto-openwrt" >> feeds.conf.default
        echo "src-git argon https://github.com/jerrykuku/luci-theme-argon" >> feeds.conf.default
        echo "src-git kms https://github.com/luodaoyi/openwrt-kms" >> feeds.conf.default

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Customize packages
      run: |
        cd openwrt
        cat >> .config <<EOF

# Add custom packages
CONFIG_PACKAGE_luci-app-passwall=y
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-mosdns=y
CONFIG_PACKAGE_luci-app-ddnsto=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-dockerman=y
CONFIG_PACKAGE_luci-app-kms=y
CONFIG_PACKAGE_docker-ce=y
CONFIG_PACKAGE_dockerd=y

EOF
        make defconfig

    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_firmware
        path: openwrt/bin/targets